#!/bin/bash
<<<<<<< Updated upstream
set -x
sudo modprobe usbip_host usbip_core || exit 1

export MACHINE="svwork"
export CLIENT="x2sixty"

usb_1="1-1"

# TODO: unify connectivity check and vm check into one, to more comfortably switch and avoid complications

bind_usb() {
	sudo usbip bind -b $usb_1
}

release_usb() {
	sudo usbip unbind -b $usb_1
}

attach_usb() {
	ssh $CLIENT "sudo usbip attach -r $MACHINE -b $usb_1"
}

release_usb() {
	ssh $SERVER "sudo usbip unbind -b $usb_1"
}

release_usb_locally() {
	sudo usbip unbind -b $usb_1
}

check_client() {
	ssh -q -o "ConnectTimeout=1" $USER@$CLIENT exit
	return $?
}

if [ "$HOSTNAME" == "$CLIENT" ]; then
	echo "Releasing devices..."
	release_usb

elif check_client; then
	if bind_usb; then
		attach_usb
	else
		release_usb_locally

	fi
fi
