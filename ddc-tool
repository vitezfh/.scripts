#!/usr/bin/env bash
# Description: Advanced DDC control for monitor brightness and contrast
# Requires: ddcutil i2c-tools
# Load utilities
source "$(dirname "$0")/_utils" || {
  echo "Failed to load utilities"
  exit 1
}

# DDC feature codes
BRIGHTNESS=10
CONTRAST=12
MAX_VALUE=100
MIN_VALUE=0

# Configuration
CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/ddc"
DISPLAYS_FILE="$CONFIG_DIR/displays"
LOG_FILE="$CONFIG_DIR/ddc.log"

# Initialize configuration directory
mkdir -p "$CONFIG_DIR"

# Main functions
detect_displays() {
  echo "Detecting displays..."
  local displays

  displays=$(sudo ddcutil detect | awk '
  /^Display/ {
    display_num = $2
    is_valid = 1  # Assume valid until proven otherwise
    next
  }
/Invalid display|This is a laptop display|DRM_connector.*eDP/ {
  is_valid = 0
}
/DRM_connector:/ && is_valid {
  print display_num
  # Reset for next display
  is_valid = 0
}
')

  if [ -z "$displays" ]; then
    check "No displays detected" "ee"
    return 1
  fi

  echo "$displays" >"$DISPLAYS_FILE"
  check "Saved displays to config" "ok"
  echo "Detected displays: $displays"
}

get_current_values() {
  local display=$1
  echo "Display $display current values:"
  sudo ddcutil --display="$display" getvcp $BRIGHTNESS $CONTRAST |
    awk '/Brightness/ {print "  Brightness:", $9} /Contrast/ {print "  Contrast:", $9}'
}

set_display_value() {
  local display=$1 feature=$2 value=$3
  local feature_name

  case $feature in
  $BRIGHTNESS) feature_name="Brightness" ;;
  $CONTRAST) feature_name="Contrast" ;;
  *) feature_name="Feature $feature" ;;
  esac

  if ! sudo ddcutil --sleep-multiplier=0.1 --noverify --skip-ddc-checks --display="$display" setvcp "$feature" "$value" >>"$LOG_FILE" 2>&1; then
    check "Failed to set $feature_name on display $display to $value" "ee"
    return 1
  fi
  check "Set $feature_name on display $display to $value" "ok"
}

set_all_displays() {
  local feature=$1 value=$2
  local displays

  if [ ! -f "$DISPLAYS_FILE" ]; then
    check "No displays config found. Run 'detect' first." "ee"
    return 1
  fi

  displays=$(cat "$DISPLAYS_FILE")
  if [ -z "$displays" ]; then
    check "No displays configured. Run 'detect' first." "ee"
    return 1
  fi

  for display in $displays; do
    set_display_value "$display" "$feature" "$value" &
  done
  wait
}

show_help() {
  echo_green "DDC Monitor Control Tool"
  echo "Usage: $TOOL_NAME [command] [options]"
  echo ""
  echo "Commands:"
  echo "  detect                     Detect and save connected displays"
  echo "  list                       List saved displays and their current values"
  echo "  brightness [value]         Set brightness (0-100)"
  echo "  contrast [value]           Set contrast (0-100)"
  echo "  set [brightness] [contrast] Set both brightness and contrast"
  echo "  get                        Get current brightness and contrast for all displays"
  echo "  help                       Show this help message"
  echo ""
  echo "Examples:"
  echo "  $TOOL_NAME detect"
  echo "  $TOOL_NAME brightness 80"
  echo "  $TOOL_NAME set 70 60"
  echo "  $TOOL_NAME get"
}

validate_value() {
  local value=$1 feature=$2
  if ! [[ "$value" =~ ^[0-9]+$ ]] || [ "$value" -lt $MIN_VALUE ] || [ "$value" -gt $MAX_VALUE ]; then
    echo_red "Error: Value must be between $MIN_VALUE and $MAX_VALUE"
    return 1
  fi
  return 0
}

main() {
  local command=$1
  shift || true

  case "$command" in
  detect)
    detect_displays
    ;;
  list | get)
    if [ ! -f "$DISPLAYS_FILE" ]; then
      check "No displays config found. Run 'detect' first." "ee"
      return 1
    fi
    for display in $(cat "$DISPLAYS_FILE"); do
      get_current_values "$display"
    done
    ;;
  brightness)
    local value=$1
    validate_value "$value" "brightness" || exit 1
    set_all_displays $BRIGHTNESS "$value"
    ;;
  contrast)
    local value=$1
    validate_value "$value" "contrast" || exit 1
    set_all_displays $CONTRAST "$value"
    ;;
  set)
    local brightness=$1 contrast=$2
    validate_value "$brightness" "brightness" || exit 1
    validate_value "$contrast" "contrast" || exit 1
    set_all_displays $BRIGHTNESS "$brightness"
    set_all_displays $CONTRAST "$contrast"
    ;;
  help | --help | -h)
    show_help
    ;;
  *)
    echo_red "Unknown command: $command"
    show_help
    exit 1
    ;;
  esac
}

# Entry point
if [ $# -eq 0 ]; then
  show_help
  exit 0
fi

main "$@"
exit_tool
